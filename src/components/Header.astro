---
import { SITE_TITLE } from '../consts';
import HeaderLink from './HeaderLink.astro';
import UserMenu from './UserMenu.vue';
---

<a href="#main-content" class="skip-link">Skip to main content</a>

<!-- MAIN HEADER -->
<header class="main-header" role="banner">
	<div class="container">
		<a href="/" class="header-logo" aria-label={`${SITE_TITLE} - Home`}>
			<div class="header-logo__icon" aria-hidden="true">
				<i class="bi bi-terminal-fill"></i>
			</div>
			<span class="header-logo__text">{SITE_TITLE}</span>
		</a>

		<button
			class="mobile-toggle"
			aria-label="Toggle navigation"
			aria-expanded="false"
			aria-controls="main-nav"
		>
			<i class="bi bi-list"></i>
		</button>

		<nav id="main-nav" class="header-nav" aria-label="Main navigation">
			<HeaderLink href="/blog" class="header-nav__link" icon="bi-journal-text">Blog</HeaderLink>
			<HeaderLink href="/about" class="header-nav__link" icon="bi-person">About</HeaderLink>
		</nav>

		<div class="header-actions">
			<a
				href="https://github.com/withastro/astro"
				target="_blank"
				rel="noopener"
				class="header-actions__github"
				aria-label="View on GitHub"
			>
				<i class="bi bi-github"></i>
			</a>

			<button
				class="theme-toggle-btn"
				aria-label="Toggle theme"
				onclick="toggleCyberTheme()"
			>
				<i class="bi bi-sun-fill"></i>
			</button>

			<div class="auth-section">
				<UserMenu client:load />
			</div>
		</div>
	</div>
</header>

<script is:inline>
	// Sync all toggle button icons to reflect current theme
	function syncThemeIcons(theme) {
		document.querySelectorAll('.theme-toggle-btn, .theme-toggle').forEach(function(btn) {
			var icon = btn.querySelector('i');
			var text = btn.querySelector('.theme-text');
			if (icon) {
				icon.className = theme === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-fill';
			}
			if (text) {
				text.textContent = theme === 'dark' ? 'Dark' : 'Light';
			}
		});
	}

	// Sync on load
	syncThemeIcons(document.documentElement.getAttribute('data-bs-theme') || 'dark');

	// Listen for theme changes from any source
	window.addEventListener('themechange', function(e) {
		syncThemeIcons(e.detail.theme);
	});
</script>

<script>
	// Mobile nav toggle (bundled module is fine for this)
	document.querySelector('.mobile-toggle')?.addEventListener('click', function (this: HTMLElement) {
		const nav = document.getElementById('main-nav');
		if (!nav) return;
		const isOpen = nav.classList.toggle('open');
		this.setAttribute('aria-expanded', String(isOpen));
		const icon = this.querySelector('i');
		if (icon) {
			icon.className = isOpen ? 'bi bi-x-lg' : 'bi bi-list';
		}
	});
</script>

<style>
	/* --- Skip Link (WCAG 2.4.1) --- */
	.skip-link {
		position: absolute;
		top: -40px;
		left: 0;
		background: var(--cyber-primary);
		color: #000;
		padding: 8px 16px;
		z-index: 9999;
		font-weight: 600;
		text-decoration: none;
		transition: top 0.2s;
	}
	.skip-link:focus {
		top: 0;
	}

	/* --- Main Header --- */
	.main-header {
		background: var(--cyber-bg-primary);
		border-bottom: 1px solid var(--cyber-border-color);
		backdrop-filter: blur(12px);
		position: sticky;
		top: 0;
		z-index: 1030;
		padding: 0;
	}

	.main-header .container {
		display: flex;
		align-items: center;
		height: 56px;
	}

	/* --- Logo --- */
	.header-logo {
		display: flex;
		align-items: center;
		gap: 10px;
		text-decoration: none;
		margin-right: 2rem;
		flex-shrink: 0;
	}

	.header-logo__icon {
		width: 32px;
		height: 32px;
		background: var(--cyber-gradient-primary);
		border-radius: 8px;
		display: flex;
		align-items: center;
		justify-content: center;
		color: #000;
		font-size: 1rem;
		font-weight: 700;
	}

	.header-logo__text {
		font-size: 1.125rem;
		font-weight: 700;
		background: var(--cyber-gradient-primary);
		-webkit-background-clip: text;
		-webkit-text-fill-color: transparent;
		background-clip: text;
	}

	/* --- Navigation --- */
	.header-nav {
		display: flex;
		align-items: center;
		gap: 2px;
		flex: 1;
	}

	/* --- Right Actions --- */
	.header-actions {
		display: flex;
		align-items: center;
		gap: 8px;
		margin-left: auto;
	}

	.header-actions__github {
		display: flex;
		align-items: center;
		justify-content: center;
		width: 32px;
		height: 32px;
		border-radius: 8px;
		color: var(--cyber-text-secondary);
		text-decoration: none;
		font-size: 1rem;
		transition: color 0.2s, background 0.2s;
	}

	.header-actions__github:hover {
		color: var(--cyber-primary);
		background: rgba(0, 255, 136, 0.1);
	}

	.auth-section {
		display: flex;
		align-items: center;
	}

	/* --- Theme Toggle Button --- */
	.theme-toggle-btn {
		display: flex;
		align-items: center;
		justify-content: center;
		width: 32px;
		height: 32px;
		border-radius: 8px;
		border: 1px solid var(--cyber-border-color);
		background: transparent;
		color: var(--cyber-text-secondary);
		font-size: 1rem;
		cursor: pointer;
		transition: color 0.2s, background 0.2s, border-color 0.2s;
	}

	.theme-toggle-btn:hover {
		color: var(--cyber-primary);
		border-color: var(--cyber-primary);
		background: rgba(0, 255, 136, 0.1);
	}

	/* --- Mobile --- */
	.mobile-toggle {
		display: none;
		background: transparent;
		border: 1px solid var(--cyber-border-color);
		border-radius: 8px;
		padding: 6px 10px;
		color: var(--cyber-text-primary);
		font-size: 1.25rem;
		cursor: pointer;
	}

	@media (max-width: 991px) {
		.mobile-toggle {
			display: flex;
		}

		.header-nav {
			display: none;
			position: absolute;
			top: 56px;
			left: 0;
			right: 0;
			background: var(--cyber-bg-secondary);
			border-bottom: 1px solid var(--cyber-border-color);
			flex-direction: column;
			padding: 8px;
			gap: 2px;
			z-index: 1029;
		}

		.header-nav.open {
			display: flex;
		}
	}

	/* --- Reduced Motion --- */
	@media (prefers-reduced-motion: reduce) {
		.theme-toggle-btn,
		.header-actions__github,
		.skip-link {
			animation: none !important;
			transition: none !important;
		}
	}
</style>
