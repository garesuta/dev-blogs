---
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import Header from '../../components/Header.astro';
import { db } from '../../lib/db';
import { posts, users, categories } from '../../lib/schema';
import { eq } from 'drizzle-orm';
import { processContentForDisplay } from '../../lib/content-processor';

export const prerender = false;

const { slug } = Astro.params;

// Fetch post from database by slug
const [post] = await db
  .select({
    id: posts.id,
    slug: posts.slug,
    title: posts.title,
    description: posts.description,
    content: posts.content,
    heroImage: posts.heroImage,
    status: posts.status,
    publishedAt: posts.publishedAt,
    createdAt: posts.createdAt,
    updatedAt: posts.updatedAt,
    authorId: posts.authorId,
    authorName: users.name,
    authorNickname: users.nickname,
    authorImage: users.image,
    categoryId: posts.categoryId,
    categoryName: categories.name,
    categorySlug: categories.slug,
    categoryColor: categories.color,
    categoryIcon: categories.icon,
    metaTitle: posts.metaTitle,
    metaDescription: posts.metaDescription,
  })
  .from(posts)
  .leftJoin(users, eq(posts.authorId, users.id))
  .leftJoin(categories, eq(posts.categoryId, categories.id))
  .where(eq(posts.slug, slug as string))
  .limit(1);

const authorDisplayName = post?.authorNickname || post?.authorName;

if (!post || post.status !== 'published') {
  return Astro.redirect('/404');
}

// Process content to add heading IDs for TOC navigation
const contentHtml = processContentForDisplay(post.content);
---

<html lang="en">
  <head>
    <BaseHead
      title={post.metaTitle || post.title}
      description={post.metaDescription || post.description}
    />
    <style>
      main {
        width: calc(100% - 2em);
        max-width: 100%;
        margin: 0;
      }
      .hero-image {
        width: 100%;
      }
      .hero-image img {
        display: block;
        margin: 0 auto;
        border-radius: 12px;
        box-shadow: var(--box-shadow);
        max-width: 100%;
        height: auto;
      }
      .prose {
        width: 720px;
        max-width: calc(100% - 2em);
        margin: auto;
        padding: 1em;
        color: rgb(var(--gray-dark));
      }
      .title {
        margin-bottom: 1em;
        padding: 1em 0;
        text-align: center;
        line-height: 1;
      }
      .title h1 {
        margin: 0 0 0.5em 0;
      }
      .date {
        margin-bottom: 0.5em;
        color: rgb(var(--gray));
      }
      .last-updated-on {
        font-style: italic;
      }
      .prose :global(pre) {
        background: #1e1e1e;
        padding: 1rem;
        border-radius: 8px;
        overflow-x: auto;
      }
      .prose :global(code) {
        font-family: 'Fira Code', monospace;
      }
      .prose :global(img) {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
      }
      .author-box {
        margin-top: 3rem;
        padding-top: 1rem;
      }
      .author-avatar {
        object-fit: cover;
      }
      .author-avatar-placeholder {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        background: #6c757d;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: bold;
        flex-shrink: 0;
      }
      /* Table of Contents styles */
      .prose :global(.toc-block) {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1rem 1.5rem;
        margin: 1.5rem 0;
      }
      .prose :global(.toc-title) {
        margin: 0 0 0.75rem 0;
        font-size: 1rem;
        color: #495057;
      }
      .prose :global(.toc-list) {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .prose :global(.toc-list li) {
        padding: 0.35rem 0;
        display: flex;
        align-items: center;
      }
      .prose :global(.toc-list li::before) {
        content: '';
        display: inline-block;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #9b9a97;
        margin-right: 10px;
        flex-shrink: 0;
      }
      /* Level-based cascading styles */
      .prose :global(.toc-list .toc-level-0) {
        padding-left: 0;
      }
      .prose :global(.toc-list .toc-level-0::before) {
        width: 8px;
        height: 8px;
        background: #495057;
      }
      .prose :global(.toc-list .toc-level-0 a) {
        font-weight: 600;
        font-size: 1rem;
      }
      .prose :global(.toc-list .toc-level-1) {
        padding-left: 1.25rem;
      }
      .prose :global(.toc-list .toc-level-1::before) {
        width: 6px;
        height: 6px;
        background: #6c757d;
      }
      .prose :global(.toc-list .toc-level-1 a) {
        font-weight: 500;
        font-size: 0.95rem;
      }
      .prose :global(.toc-list .toc-level-2) {
        padding-left: 2.5rem;
      }
      .prose :global(.toc-list .toc-level-2::before) {
        width: 5px;
        height: 5px;
        background: #adb5bd;
      }
      .prose :global(.toc-list .toc-level-2 a) {
        font-weight: 400;
        font-size: 0.9rem;
        color: #6c757d;
      }
      .prose :global(.toc-list .toc-level-3) {
        padding-left: 3.75rem;
      }
      .prose :global(.toc-list .toc-level-3::before) {
        width: 4px;
        height: 4px;
        background: #ced4da;
      }
      .prose :global(.toc-list .toc-level-3 a) {
        font-weight: 400;
        font-size: 0.85rem;
        color: #868e96;
      }
      .prose :global(.toc-list a) {
        color: #495057;
        text-decoration: none;
        transition: color 0.15s;
      }
      .prose :global(.toc-list a:hover) {
        color: #0d6efd;
        text-decoration: underline;
      }
      .prose :global(.toc-placeholder) {
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 4px;
        padding: 0.75rem 1rem;
        color: #856404;
      }
      /* Smooth scroll for anchor links */
      :global(html) {
        scroll-behavior: smooth;
      }
    </style>
  </head>

  <body>
    <Header />
    <main>
      <article>
        {post.heroImage && (
          <div class="hero-image">
            <img
              src={post.heroImage}
              alt={post.title}
              width="1020"
              height="510"
              style="object-fit: cover;"
            />
          </div>
        )}
        <div class="prose">
          <div class="title">
            <div class="date">
              {post.publishedAt && (
                <time datetime={post.publishedAt.toISOString()}>
                  {post.publishedAt.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                  })}
                </time>
              )}
              {post.updatedAt && post.publishedAt && post.updatedAt > post.publishedAt && (
                <div class="last-updated-on">
                  Last updated on {post.updatedAt.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                  })}
                </div>
              )}
            </div>
            {post.categoryName && (
              <a
                href={`/blog?category=${post.categorySlug}`}
                class="badge mb-2"
                style={post.categoryColor ? `background-color: ${post.categoryColor};` : ''}
              >
                {post.categoryIcon && <i class={`bi ${post.categoryIcon} me-1`}></i>}
                {post.categoryName}
              </a>
            )}
            <h1>{post.title}</h1>
            {authorDisplayName && (
              <p class="text-muted small">
                <i class="bi bi-person me-1"></i>
                By {authorDisplayName}
              </p>
            )}
            <hr />
          </div>
          <div set:html={contentHtml} />

          <!-- Author Box at end of post -->
          {authorDisplayName && (
            <div class="author-box">
              <hr />
              <div class="d-flex align-items-center gap-3">
                {post.authorImage ? (
                  <img
                    src={post.authorImage}
                    alt={authorDisplayName}
                    class="author-avatar rounded-circle"
                    width="64"
                    height="64"
                  />
                ) : (
                  <div class="author-avatar-placeholder">
                    {authorDisplayName.charAt(0).toUpperCase()}
                  </div>
                )}
                <div>
                  <p class="mb-0 fw-semibold">
                    Written by {authorDisplayName}
                  </p>
                  <p class="mb-0 text-muted small">
                    {post.publishedAt?.toLocaleDateString('en-US', {
                      year: 'numeric',
                      month: 'long',
                      day: 'numeric'
                    })}
                  </p>
                </div>
              </div>
            </div>
          )}
        </div>
      </article>
    </main>
    <Footer />
  </body>
</html>
