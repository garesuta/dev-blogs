---
import BaseHead from "../components/BaseHead.astro";
import Footer from "../components/Footer.astro";
import Header from "../components/Header.astro";
import ProfileEditor from "../components/ProfileEditor.vue";
import AuthorStats from "../components/AuthorStats.vue";
import RecentPosts from "../components/RecentPosts.vue";
import { SITE_TITLE } from "../consts";
import { getRoleDisplayName } from "../lib/permissions";
import { db } from "../lib/db";
import { users, posts } from "../lib/schema";
import { eq, desc, and, count } from "drizzle-orm";
import type { UserRole } from "../lib/schema";

export const prerender = false;

const user = Astro.locals.user;

if (!user) {
  return Astro.redirect("/login?redirect=/profile");
}

// Fetch full user data including all profile fields
const [fullUser] = await db
  .select({
    id: users.id,
    name: users.name,
    nickname: users.nickname,
    email: users.email,
    image: users.image,
    role: users.role,
    emailVerified: users.emailVerified,
    bio: users.bio,
    website: users.website,
    twitter: users.twitter,
    github: users.github,
    linkedin: users.linkedin,
    coverImage: users.coverImage,
    isPublic: users.isPublic,
    createdAt: users.createdAt,
  })
  .from(users)
  .where(eq(users.id, user.id))
  .limit(1);

// Fetch post count
const [postCountResult] = await db
  .select({ count: count() })
  .from(posts)
  .where(and(eq(posts.authorId, user.id), eq(posts.status, "published")));

// Fetch recent posts
const recentPosts = await db
  .select({
    id: posts.id,
    slug: posts.slug,
    title: posts.title,
    publishedAt: posts.publishedAt,
    createdAt: posts.createdAt,
  })
  .from(posts)
  .where(and(eq(posts.authorId, user.id), eq(posts.status, "published")))
  .orderBy(desc(posts.publishedAt))
  .limit(5);

const roleName = getRoleDisplayName(fullUser.role as UserRole);
const displayName = fullUser.nickname || fullUser.name;
const postCount = postCountResult?.count || 0;

// Check if user has any social links
const hasSocialLinks = fullUser.website || fullUser.twitter || fullUser.github || fullUser.linkedin;
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={`Profile - ${SITE_TITLE}`} description="Your profile" />
  </head>
  <body>
    <Header />
    <main class="profile-page">
      <!-- Profile Header with Gradient -->
      <div class="profile-header">
        <div class="profile-header-bg"></div>
        <div class="profile-container">
          <div class="profile-header-content">
            <div class="profile-avatar-wrapper">
              {fullUser.image ? (
                <img
                  src={fullUser.image}
                  alt={displayName}
                  class="profile-avatar"
                />
              ) : (
                <div class="profile-avatar profile-avatar-placeholder">
                  {displayName.charAt(0).toUpperCase()}
                </div>
              )}
              <span class={`profile-role-badge ${fullUser.role === 'admin' ? 'role-admin' : fullUser.role === 'editor' ? 'role-editor' : 'role-user'}`}>
                {roleName}
              </span>
            </div>
            <div class="profile-header-info">
              <h1 class="profile-name">{displayName}</h1>
              {fullUser.nickname && (
                <p class="profile-account-name">
                  <i class="bi bi-at"></i>{fullUser.name}
                </p>
              )}
              <p class="profile-email">
                <i class="bi bi-envelope me-1"></i>
                {fullUser.email}
                {fullUser.emailVerified ? (
                  <span class="verified-badge" title="Email verified">
                    <i class="bi bi-patch-check-fill"></i>
                  </span>
                ) : (
                  <span class="unverified-badge" title="Email not verified">
                    <i class="bi bi-exclamation-circle"></i>
                  </span>
                )}
              </p>
              {fullUser.bio && (
                <p class="profile-bio">{fullUser.bio}</p>
              )}
              {hasSocialLinks && (
                <div class="profile-social-links">
                  {fullUser.website && (
                    <a href={fullUser.website} target="_blank" rel="noopener noreferrer" class="social-link" title="Website">
                      <i class="bi bi-globe"></i>
                    </a>
                  )}
                  {fullUser.twitter && (
                    <a href={`https://twitter.com/${fullUser.twitter}`} target="_blank" rel="noopener noreferrer" class="social-link" title="Twitter">
                      <i class="bi bi-twitter-x"></i>
                    </a>
                  )}
                  {fullUser.github && (
                    <a href={`https://github.com/${fullUser.github}`} target="_blank" rel="noopener noreferrer" class="social-link" title="GitHub">
                      <i class="bi bi-github"></i>
                    </a>
                  )}
                  {fullUser.linkedin && (
                    <a href={`https://linkedin.com/in/${fullUser.linkedin}`} target="_blank" rel="noopener noreferrer" class="social-link" title="LinkedIn">
                      <i class="bi bi-linkedin"></i>
                    </a>
                  )}
                </div>
              )}
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="profile-container py-4">
        <div class="row g-4">
          <!-- Left Column: Stats & Actions -->
          <div class="col-12 col-lg-4 col-xl-3">
            <div class="sidebar-sticky">
              <!-- Author Stats -->
              <AuthorStats
                client:load
                postCount={postCount}
                memberSince={fullUser.createdAt.toISOString()}
                isPublic={fullUser.isPublic || false}
              />

              <!-- Account Info -->
              <div class="profile-card sidebar-card mb-3">
                <h5 class="profile-card-title">
                  <i class="bi bi-info-circle me-2"></i>
                  Account Info
                </h5>
                <ul class="profile-info-list">
                  <li>
                    <div class="info-icon">
                      <i class="bi bi-calendar3"></i>
                    </div>
                    <div class="info-content">
                      <span class="info-label">Member since</span>
                      <span class="info-value">
                        {new Date(fullUser.createdAt).toLocaleDateString("en-US", {
                          year: "numeric",
                          month: "short",
                          day: "numeric",
                        })}
                      </span>
                    </div>
                  </li>
                  <li>
                    <div class="info-icon">
                      <i class="bi bi-shield-check"></i>
                    </div>
                    <div class="info-content">
                      <span class="info-label">Account status</span>
                      <span class="info-value">
                        <span class="status-badge status-active">Active</span>
                      </span>
                    </div>
                  </li>
                  <li>
                    <div class="info-icon">
                      <i class="bi bi-person-badge"></i>
                    </div>
                    <div class="info-content">
                      <span class="info-label">Role</span>
                      <span class="info-value">{roleName}</span>
                    </div>
                  </li>
                  <li>
                    <div class="info-icon">
                      <i class="bi bi-envelope-check"></i>
                    </div>
                    <div class="info-content">
                      <span class="info-label">Email verified</span>
                      <span class="info-value">
                        {fullUser.emailVerified ? (
                          <span class="status-badge status-active">Yes</span>
                        ) : (
                          <span class="status-badge status-pending">Pending</span>
                        )}
                      </span>
                    </div>
                  </li>
                </ul>
              </div>

              <!-- Quick Actions -->
              <div class="profile-card sidebar-card">
                <h5 class="profile-card-title">
                  <i class="bi bi-lightning me-2"></i>
                  Quick Actions
                </h5>
                <div class="quick-actions-stack">
                  <a href="/" class="quick-action-btn">
                    <i class="bi bi-house"></i>
                    <span>Home</span>
                    <i class="bi bi-chevron-right ms-auto"></i>
                  </a>
                  <a href="/blog" class="quick-action-btn">
                    <i class="bi bi-journal-text"></i>
                    <span>Blog</span>
                    <i class="bi bi-chevron-right ms-auto"></i>
                  </a>
                  {fullUser.isPublic && (
                    <a href={`/author/${fullUser.id}`} class="quick-action-btn">
                      <i class="bi bi-person-lines-fill"></i>
                      <span>Public Profile</span>
                      <i class="bi bi-chevron-right ms-auto"></i>
                    </a>
                  )}
                  {(fullUser.role === 'admin' || fullUser.role === 'editor') && (
                    <a href="/editor" class="quick-action-btn">
                      <i class="bi bi-pencil-square"></i>
                      <span>Content Editor</span>
                      <i class="bi bi-chevron-right ms-auto"></i>
                    </a>
                  )}
                  {fullUser.role === 'admin' && (
                    <a href="/admin" class="quick-action-btn btn-admin">
                      <i class="bi bi-gear"></i>
                      <span>Admin Panel</span>
                      <i class="bi bi-chevron-right ms-auto"></i>
                    </a>
                  )}
                </div>
              </div>
            </div>
          </div>

          <!-- Right Column: Edit Profile & Recent Posts -->
          <div class="col-12 col-lg-8 col-xl-9">
            <div class="profile-card mb-4">
              <ProfileEditor
                client:load
                initialNickname={fullUser.nickname}
                initialBio={fullUser.bio}
                initialWebsite={fullUser.website}
                initialTwitter={fullUser.twitter}
                initialGithub={fullUser.github}
                initialLinkedin={fullUser.linkedin}
                initialIsPublic={fullUser.isPublic}
              />
            </div>

            <!-- Recent Posts -->
            {(fullUser.role === 'admin' || fullUser.role === 'editor') && (
              <div class="profile-card">
                <RecentPosts
                  client:load
                  posts={recentPosts}
                  totalCount={postCount}
                />
              </div>
            )}
          </div>
        </div>
      </div>
    </main>
    <Footer />
  </body>
</html>

<style>
  /* Responsive container - scales with viewport */
  .profile-container {
    width: 100%;
    max-width: 100%;
    margin-left: auto;
    margin-right: auto;
    padding-left: 1rem;
    padding-right: 1rem;
  }

  /* Tablet: constrained width */
  @media (min-width: 768px) {
    .profile-container {
      width: 95%;
      max-width: 1400px;
      padding-left: 1.5rem;
      padding-right: 1.5rem;
    }
  }

  /* Desktop: larger max-width */
  @media (min-width: 1200px) {
    .profile-container {
      width: 92%;
      max-width: 1600px;
      padding-left: 2rem;
      padding-right: 2rem;
    }
  }

  /* Large desktop: even wider */
  @media (min-width: 1600px) {
    .profile-container {
      width: 90%;
      max-width: 1800px;
    }
  }

  /* Extra large screens: maximum width with good margins */
  @media (min-width: 1920px) {
    .profile-container {
      width: 88%;
      max-width: 2000px;
    }
  }

  /* Profile Header */
  .profile-page {
    /* Override global main width: 720px */
    width: 100%;
    max-width: 100%;
    padding: 0;
    background: #f8f9fa;
    min-height: calc(100vh - 200px);
  }

  .profile-header {
    position: relative;
    padding: 3rem 0 4rem;
    margin-bottom: -2rem;
  }

  .profile-header-bg {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    z-index: 0;
  }

  .profile-header-content {
    position: relative;
    z-index: 1;
    display: flex;
    align-items: flex-start;
    gap: 1.5rem;
  }

  .profile-avatar-wrapper {
    position: relative;
    flex-shrink: 0;
  }

  .profile-avatar {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    border: 4px solid white;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    object-fit: cover;
  }

  .profile-avatar-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    font-size: 3rem;
    font-weight: 700;
  }

  .profile-role-badge {
    position: absolute;
    bottom: 0;
    right: 0;
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border: 2px solid white;
  }

  .role-admin {
    background: #dc3545;
    color: white;
  }

  .role-editor {
    background: #ffc107;
    color: #212529;
  }

  .role-user {
    background: #6c757d;
    color: white;
  }

  .profile-header-info {
    color: white;
    flex: 1;
  }

  .profile-name {
    font-size: 2rem;
    font-weight: 700;
    margin: 0 0 0.25rem;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .profile-account-name {
    margin: 0 0 0.5rem;
    opacity: 0.9;
    font-size: 1rem;
  }

  .profile-email {
    margin: 0 0 0.75rem;
    opacity: 0.85;
    font-size: 0.95rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .profile-bio {
    margin: 0.75rem 0 0;
    opacity: 0.95;
    font-size: 0.95rem;
    line-height: 1.5;
    max-width: 600px;
  }

  .profile-social-links {
    display: flex;
    gap: 0.75rem;
    margin-top: 1rem;
  }

  .social-link {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .social-link:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
    color: white;
  }

  .social-link i {
    font-size: 1.1rem;
  }

  .verified-badge {
    color: #90EE90;
  }

  .unverified-badge {
    color: #ffc107;
  }

  /* Profile Cards */
  .profile-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
  }

  @media (min-width: 992px) {
    .profile-card {
      padding: 2rem;
    }
  }

  .profile-card-title {
    font-size: 1rem;
    font-weight: 600;
    color: #495057;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid #e9ecef;
  }

  /* Sidebar */
  .sidebar-sticky {
    position: sticky;
    top: 1rem;
  }

  .sidebar-card {
    border: 1px solid #e9ecef;
  }

  /* Info List */
  .profile-info-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .profile-info-list li {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 0.75rem 0;
    border-bottom: 1px solid #f1f3f4;
  }

  .profile-info-list li:last-child {
    border-bottom: none;
    padding-bottom: 0;
  }

  .profile-info-list li:first-child {
    padding-top: 0;
  }

  .info-icon {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    color: #667eea;
  }

  .info-content {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
    min-width: 0;
  }

  .info-label {
    color: #6c757d;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .info-value {
    font-weight: 600;
    color: #212529;
    font-size: 0.9rem;
  }

  .status-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .status-badge.status-active {
    background: #d4edda;
    color: #155724;
  }

  .status-badge.status-pending {
    background: #fff3cd;
    color: #856404;
  }

  /* Quick Actions */
  .quick-actions-stack {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .quick-action-btn {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    background: #f8f9fa;
    color: #495057;
    text-decoration: none;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.2s ease;
    border: 1px solid transparent;
  }

  .quick-action-btn:hover {
    background: #667eea;
    color: white;
    transform: translateX(4px);
  }

  .quick-action-btn:hover i {
    color: white;
  }

  .quick-action-btn i:first-child {
    font-size: 1.1rem;
    width: 20px;
    text-align: center;
    color: #667eea;
  }

  .quick-action-btn i:last-child {
    font-size: 0.75rem;
    opacity: 0.5;
  }

  .quick-action-btn.btn-admin {
    background: linear-gradient(135deg, #dc354515 0%, #fd7e1415 100%);
  }

  .quick-action-btn.btn-admin i:first-child {
    color: #dc3545;
  }

  .quick-action-btn.btn-admin:hover {
    background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .profile-header-content {
      flex-direction: column;
      text-align: center;
      align-items: center;
    }

    .profile-avatar {
      width: 100px;
      height: 100px;
    }

    .profile-avatar-placeholder {
      font-size: 2.5rem;
    }

    .profile-name {
      font-size: 1.5rem;
    }

    .profile-email {
      justify-content: center;
      flex-wrap: wrap;
    }

    .profile-bio {
      text-align: center;
    }

    .profile-social-links {
      justify-content: center;
    }
  }
</style>
