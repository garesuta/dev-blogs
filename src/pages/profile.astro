---
import BaseHead from "../components/BaseHead.astro";
import Footer from "../components/Footer.astro";
import Header from "../components/Header.astro";
import UserMenu from "../components/UserMenu.vue";
import { SITE_TITLE } from "../consts";
import { getRoleDisplayName } from "../lib/permissions";
import type { UserRole } from "../lib/schema";

const user = Astro.locals.user;

if (!user) {
  return Astro.redirect("/login?redirect=/profile");
}

const roleName = getRoleDisplayName(user.role as UserRole);
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={`Profile - ${SITE_TITLE}`} description="Your profile" />
  </head>
  <body>
    <Header />
    <main class="container py-5">
      <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
          <div class="card shadow-sm">
            <div class="card-body text-center p-4">
              {user.image ? (
                <img
                  src={user.image}
                  alt={user.name}
                  class="rounded-circle mb-3"
                  width="100"
                  height="100"
                />
              ) : (
                <div class="avatar-placeholder mx-auto mb-3">
                  {user.name.charAt(0).toUpperCase()}
                </div>
              )}

              <h1 class="h3 mb-1">{user.name}</h1>
              <p class="text-muted mb-3">{user.email}</p>

              <span class={`badge ${user.role === 'admin' ? 'bg-danger' : user.role === 'editor' ? 'bg-warning text-dark' : 'bg-secondary'}`}>
                {roleName}
              </span>
            </div>

            <div class="card-footer bg-white">
              <table class="table table-borderless mb-0">
                <tbody>
                  <tr>
                    <th class="text-muted">User ID</th>
                    <td><code>{user.id}</code></td>
                  </tr>
                  <tr>
                    <th class="text-muted">Email Verified</th>
                    <td>
                      {user.emailVerified ? (
                        <span class="text-success">Yes</span>
                      ) : (
                        <span class="text-warning">No</span>
                      )}
                    </td>
                  </tr>
                  <tr>
                    <th class="text-muted">Member Since</th>
                    <td>
                      {new Date(user.createdAt).toLocaleDateString("en-US", {
                        year: "numeric",
                        month: "long",
                        day: "numeric",
                      })}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="d-flex justify-content-center gap-3 mt-4">
            <a href="/" class="btn btn-outline-secondary">Back to Home</a>
            {(user.role === 'admin' || user.role === 'editor') && (
              <a href="/editor" class="btn btn-outline-primary">Content Editor</a>
            )}
            {user.role === 'admin' && (
              <a href="/admin" class="btn btn-primary">Admin Panel</a>
            )}
          </div>
        </div>
      </div>
    </main>
    <Footer />
  </body>
</html>

<style>
  .avatar-placeholder {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: #6c757d;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5rem;
    font-weight: bold;
  }
</style>
