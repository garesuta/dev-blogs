---
export const prerender = false;

import AdminLayout from "../../../../layouts/AdminLayout.astro";
import { db } from "../../../../lib/db";
import { posts, users } from "../../../../lib/schema";
import { eq } from "drizzle-orm";

const { id } = Astro.params;

// Fetch post data
const [post] = await db
  .select({
    id: posts.id,
    slug: posts.slug,
    title: posts.title,
    description: posts.description,
    content: posts.content,
    heroImage: posts.heroImage,
    status: posts.status,
    publishedAt: posts.publishedAt,
    createdAt: posts.createdAt,
    updatedAt: posts.updatedAt,
    authorName: users.name,
  })
  .from(posts)
  .leftJoin(users, eq(posts.authorId, users.id))
  .where(eq(posts.id, id!))
  .limit(1);

if (!post) {
  return Astro.redirect("/editor/posts");
}

// Simple markdown to HTML conversion for preview
// In production, you'd use a proper markdown parser
function simpleMarkdownToHtml(markdown: string): string {
  return markdown
    // Headers
    .replace(/^### (.*$)/gim, '<h3>$1</h3>')
    .replace(/^## (.*$)/gim, '<h2>$1</h2>')
    .replace(/^# (.*$)/gim, '<h1>$1</h1>')
    // Bold
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    // Italic
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    // Code blocks
    .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
    // Inline code
    .replace(/`(.+?)`/g, '<code>$1</code>')
    // Links
    .replace(/\[(.+?)\]\((.+?)\)/g, '<a href="$2">$1</a>')
    // Images
    .replace(/!\[(.+?)\]\((.+?)\)/g, '<img src="$2" alt="$1" class="img-fluid">')
    // Line breaks
    .replace(/\n\n/g, '</p><p>')
    // Wrap in paragraphs
    .replace(/^(.+)$/gm, '<p>$1</p>')
    // Clean up empty paragraphs
    .replace(/<p><\/p>/g, '')
    .replace(/<p>(<h[1-6]>)/g, '$1')
    .replace(/(<\/h[1-6]>)<\/p>/g, '$1');
}

const htmlContent = simpleMarkdownToHtml(post.content);
const formatDate = (date: Date | null) => {
  if (!date) return "";
  return date.toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
};
---

<AdminLayout title="Preview Post">
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/editor">Content</a></li>
      <li class="breadcrumb-item"><a href="/editor/posts">Posts</a></li>
      <li class="breadcrumb-item"><a href={`/editor/posts/${id}`}>Edit</a></li>
      <li class="breadcrumb-item active" aria-current="page">Preview</li>
    </ol>
  </nav>

  <!-- Preview banner -->
  <div class="alert alert-info d-flex justify-content-between align-items-center mb-4">
    <div>
      <strong>Preview Mode</strong> - This is how your post will look when published.
      <span class="badge bg-{post.status === 'published' ? 'success' : 'secondary'} ms-2">
        {post.status}
      </span>
    </div>
    <div>
      <a href={`/editor/posts/${id}`} class="btn btn-sm btn-outline-primary me-2">
        Edit Post
      </a>
      {post.status === 'published' && (
        <a href={`/blog/${post.slug}`} class="btn btn-sm btn-primary" target="_blank">
          View Live
        </a>
      )}
    </div>
  </div>

  <!-- Post preview -->
  <article class="card">
    {post.heroImage && (
      <img
        src={post.heroImage}
        alt={post.title}
        class="card-img-top"
        style="max-height: 400px; object-fit: cover;"
      />
    )}
    <div class="card-body">
      <h1 class="card-title mb-3">{post.title}</h1>

      <div class="text-muted mb-4">
        <span>By {post.authorName || "Unknown"}</span>
        {post.publishedAt && (
          <>
            <span class="mx-2">â€¢</span>
            <time datetime={post.publishedAt.toISOString()}>
              {formatDate(post.publishedAt)}
            </time>
          </>
        )}
      </div>

      <p class="lead">{post.description}</p>

      <hr />

      <div class="post-content" set:html={htmlContent} />
    </div>
  </article>
</AdminLayout>

<style>
  .post-content {
    line-height: 1.8;
  }

  .post-content h1,
  .post-content h2,
  .post-content h3 {
    margin-top: 1.5rem;
    margin-bottom: 1rem;
  }

  .post-content pre {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 0.375rem;
    overflow-x: auto;
  }

  .post-content code {
    background-color: #f8f9fa;
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
  }

  .post-content pre code {
    background-color: transparent;
    padding: 0;
  }

  .post-content img {
    max-width: 100%;
    height: auto;
    margin: 1rem 0;
  }

  .post-content blockquote {
    border-left: 4px solid #dee2e6;
    padding-left: 1rem;
    margin-left: 0;
    color: #6c757d;
  }
</style>
