# Feature: Admin Blog CMS Panel

## 1. Overview

- **Goal**: Build a full-featured blog content management system accessible to Admin and Editor roles
- **Value**: Enable non-technical users to create, edit, and publish blog posts with rich markdown editing, image uploads, and SEO optimization without touching the codebase
- **In Scope**:
  - Blog post CRUD operations (Create, Read, Update, Delete)
  - Rich markdown editor with WYSIWYG (Toast UI Editor)
  - Image upload to MinIO (S3-compatible storage)
  - SEO management (custom URLs, meta descriptions, Open Graph tags)
  - Post scheduling (publish at future date)
  - Auto-save drafts with manual publish
  - Content versioning with rollback capability
  - Emoji support in content
- **Out of Scope**:
  - Comments/reactions system
  - Analytics dashboard
  - Multi-language/i18n support
  - Media library management (beyond per-post uploads)
  - Bulk operations on posts

## 2. Requirements Summary

| Requirement | Detail | Priority |
|-------------|--------|----------|
| Role-based access | Admin & Editor roles can access CMS | P0 |
| Markdown editor | Toast UI Editor with WYSIWYG mode | P0 |
| Image uploads | Upload to MinIO via presigned URLs | P0 |
| SEO fields | Custom slug, meta description, OG tags | P0 |
| Draft/Publish workflow | Save drafts, publish when ready | P0 |
| Auto-save | Periodic auto-save of drafts (30s interval) | P0 |
| Post scheduling | Set future publish date/time | P1 |
| Content versioning | Track all changes, allow rollback | P1 |
| Emoji support | Emoji picker in editor | P1 |
| Hero image | Featured image for blog posts | P0 |

## 3. Architecture & Design

### Component Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Admin CMS Panel                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐          │
│  │  Post List   │───▶│  Post Editor │───▶│  Post Preview│          │
│  │   (Vue)      │    │    (Vue)     │    │    (Vue)     │          │
│  └──────────────┘    └──────────────┘    └──────────────┘          │
│         │                   │                    │                   │
│         ▼                   ▼                    ▼                   │
│  ┌─────────────────────────────────────────────────────────┐       │
│  │                    API Layer (Astro)                     │       │
│  │  /api/posts/*  /api/upload/*  /api/versions/*           │       │
│  └─────────────────────────────────────────────────────────┘       │
│                              │                                       │
└──────────────────────────────┼───────────────────────────────────────┘
                               │
        ┌──────────────────────┼──────────────────────┐
        │                      │                      │
        ▼                      ▼                      ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│  PostgreSQL  │    │    MinIO     │    │  MDX Files   │
│  (Neon DB)   │    │  (Railway)   │    │  (Generated) │
│              │    │              │    │              │
│ - posts      │    │ - images     │    │ - Published  │
│ - versions   │    │ - assets     │    │   content    │
│ - drafts     │    │              │    │              │
└──────────────┘    └──────────────┘    └──────────────┘
```

### Data Flow

1. **Create Post**:
   - Editor opens new post form
   - Auto-save creates draft in DB every 30 seconds
   - Images uploaded via presigned URL to MinIO
   - On publish: generates MDX file OR schedules for future

2. **Edit Post**:
   - Load post from DB (draft) or parse existing MDX
   - Create new version on save
   - Update MDX file on publish

3. **Version Control**:
   - Each save creates a version record
   - User can view version history
   - Rollback replaces current content with selected version

### Data Model & Migration

#### New Tables

```sql
-- Blog posts table (stores all post data including drafts)
CREATE TABLE posts (
  id TEXT PRIMARY KEY,
  slug TEXT UNIQUE NOT NULL,
  title TEXT NOT NULL,
  description TEXT NOT NULL,
  content TEXT NOT NULL,
  hero_image TEXT,
  status TEXT NOT NULL DEFAULT 'draft', -- draft | published | scheduled
  publish_date TIMESTAMP,
  scheduled_date TIMESTAMP,
  author_id TEXT NOT NULL REFERENCES users(id),

  -- SEO fields
  meta_title TEXT,
  meta_description TEXT,
  og_title TEXT,
  og_description TEXT,
  og_image TEXT,
  canonical_url TEXT,

  -- Timestamps
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
  published_at TIMESTAMP
);

-- Post versions for history/rollback
CREATE TABLE post_versions (
  id TEXT PRIMARY KEY,
  post_id TEXT NOT NULL REFERENCES posts(id) ON DELETE CASCADE,
  version_number INTEGER NOT NULL,
  title TEXT NOT NULL,
  description TEXT NOT NULL,
  content TEXT NOT NULL,
  hero_image TEXT,
  meta_title TEXT,
  meta_description TEXT,
  og_title TEXT,
  og_description TEXT,
  og_image TEXT,

  -- Version metadata
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  created_by TEXT NOT NULL REFERENCES users(id),
  change_summary TEXT,

  UNIQUE(post_id, version_number)
);

-- Image uploads tracking
CREATE TABLE post_images (
  id TEXT PRIMARY KEY,
  post_id TEXT REFERENCES posts(id) ON DELETE SET NULL,
  filename TEXT NOT NULL,
  original_name TEXT NOT NULL,
  minio_key TEXT NOT NULL,
  minio_bucket TEXT NOT NULL,
  mime_type TEXT NOT NULL,
  size_bytes INTEGER NOT NULL,
  url TEXT NOT NULL,
  uploaded_by TEXT NOT NULL REFERENCES users(id),
  created_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- Indexes for performance
CREATE INDEX idx_posts_slug ON posts(slug);
CREATE INDEX idx_posts_status ON posts(status);
CREATE INDEX idx_posts_author ON posts(author_id);
CREATE INDEX idx_posts_scheduled ON posts(scheduled_date) WHERE status = 'scheduled';
CREATE INDEX idx_post_versions_post_id ON post_versions(post_id);
CREATE INDEX idx_post_images_post_id ON post_images(post_id);
```

#### Migration Strategy (Expand-Contract)

1. **EXPAND Phase**:
   - Add new tables (posts, post_versions, post_images)
   - Tables are additive, no breaking changes
   - Existing MDX files continue to work

2. **MIGRATE Phase**:
   - Import existing MDX files into posts table (one-time script)
   - New posts created via CMS
   - Both DB and MDX sources work during transition

3. **CONTRACT Phase** (Future):
   - Optional: Switch blog to read from DB instead of MDX
   - Or keep hybrid: DB for drafts, MDX for published (recommended)

#### Rollback SQL

```sql
-- Rollback migration (safe to run)
DROP TABLE IF EXISTS post_images;
DROP TABLE IF EXISTS post_versions;
DROP TABLE IF EXISTS posts;
```

## 4. Implementation Steps

### Phase 1: Database & API Foundation

- [ ] **1.1** Add new tables to schema (`src/lib/schema.ts`)
  - posts table with all fields
  - post_versions table
  - post_images table
  - Export TypeScript types

- [ ] **1.2** Generate and run Drizzle migration
  - `pnpm drizzle-kit generate`
  - `pnpm drizzle-kit migrate`

- [ ] **1.3** Create API endpoints for posts CRUD
  - `POST /api/posts` - Create new post
  - `GET /api/posts` - List all posts (with pagination)
  - `GET /api/posts/[id]` - Get single post
  - `PUT /api/posts/[id]` - Update post
  - `DELETE /api/posts/[id]` - Delete post
  - `POST /api/posts/[id]/publish` - Publish post
  - `POST /api/posts/[id]/unpublish` - Unpublish post

- [ ] **1.4** Create API endpoints for versions
  - `GET /api/posts/[id]/versions` - List versions
  - `GET /api/posts/[id]/versions/[versionId]` - Get specific version
  - `POST /api/posts/[id]/versions/[versionId]/restore` - Restore version

- [ ] **1.5** Add Zod validation schemas for post data
  - Create post schema
  - Update post schema
  - SEO fields validation

### Phase 2: MinIO Image Upload

- [ ] **2.1** Install MinIO JavaScript SDK
  - `pnpm add minio`

- [ ] **2.2** Create MinIO client configuration
  - `src/lib/minio.ts` - Client setup with env vars
  - Bucket configuration

- [ ] **2.3** Create upload API endpoints
  - `POST /api/upload/presign` - Generate presigned PUT URL
  - `POST /api/upload/confirm` - Confirm upload, save to DB
  - `DELETE /api/upload/[id]` - Delete uploaded image

- [ ] **2.4** Add environment variables
  ```env
  MINIO_ENDPOINT=your-minio.railway.app
  MINIO_PORT=443
  MINIO_USE_SSL=true
  MINIO_ACCESS_KEY=your-access-key
  MINIO_SECRET_KEY=your-secret-key
  MINIO_BUCKET=blog-images
  ```

### Phase 3: Toast UI Editor Integration

- [ ] **3.1** Install Toast UI Editor packages
  - `pnpm add @toast-ui/editor`
  - `pnpm add tui-editor-vue3` (Vue 3 wrapper)

- [ ] **3.2** Create BlogEditor Vue component
  - `src/components/BlogEditor.vue`
  - WYSIWYG/Markdown toggle
  - Custom toolbar configuration
  - Image upload hook integration
  - Emoji plugin setup

- [ ] **3.3** Implement auto-save functionality
  - Debounced save (30 second interval)
  - Visual indicator for save status
  - Conflict detection (if edited elsewhere)

- [ ] **3.4** Create SEO fields component
  - `src/components/SeoFields.vue`
  - Slug editor with auto-generation
  - Meta title/description with character count
  - OG fields with preview
  - Canonical URL field

### Phase 4: Admin Panel UI

- [ ] **4.1** Create post list page
  - `src/pages/editor/posts/index.astro`
  - Table with title, status, author, date
  - Filter by status (draft/published/scheduled)
  - Search by title
  - Pagination

- [ ] **4.2** Create post editor page
  - `src/pages/editor/posts/new.astro`
  - `src/pages/editor/posts/[id].astro`
  - Full editor with sidebar for settings

- [ ] **4.3** Create post preview page
  - `src/pages/editor/posts/[id]/preview.astro`
  - Render markdown to HTML
  - Show how it will look when published

- [ ] **4.4** Create version history page
  - `src/pages/editor/posts/[id]/history.astro`
  - List all versions with diff view
  - Restore functionality

- [ ] **4.5** Update navigation
  - Add "Posts" link to admin sidebar
  - Update editor dashboard with quick actions

### Phase 5: Publishing & Scheduling

- [ ] **5.1** Implement MDX file generation
  - Convert DB post to MDX format
  - Write to `src/content/blog/[slug].mdx`
  - Handle frontmatter generation

- [ ] **5.2** Create scheduling system
  - Store scheduled posts in DB
  - Cron job or server action to check scheduled posts
  - Auto-publish when schedule time passes

- [ ] **5.3** Handle unpublishing
  - Remove MDX file on unpublish
  - Keep post in DB as draft

### Phase 6: Hero Image & Media

- [ ] **6.1** Create hero image upload component
  - Drag-and-drop zone
  - Image preview
  - Crop/resize option (optional)

- [ ] **6.2** Integrate with post editor
  - Hero image in post settings sidebar
  - Store URL in post record

### Phase 7: Polish & Testing

- [ ] **7.1** Add loading states and error handling
  - Skeleton loaders
  - Toast notifications for actions
  - Error boundaries

- [ ] **7.2** Add keyboard shortcuts
  - Ctrl+S to save
  - Ctrl+Shift+P to publish

- [ ] **7.3** Write tests
  - API endpoint tests
  - Component tests for editor

- [ ] **7.4** Update documentation
  - Usage guide for editors
  - API documentation

## 5. Operational Readiness

### Observability

| Type | Implementation |
|------|----------------|
| Logs | Log post creates/updates/publishes with user ID |
| Metrics | Track: posts created, images uploaded, publish rate |
| Alerts | Alert on: upload failures, publish failures |
| Dashboard | Post count by status, recent activity |

### Rollout Strategy

| Stage | % Users | Duration | Criteria |
|-------|---------|----------|----------|
| Dev | Internal | Until stable | All features working |
| Canary | 1 admin | 48h | No data loss, smooth UX |
| GA | All editors | - | No blocking issues |

### Resource & Cost Impact

- **Compute**: Minimal - API endpoints are lightweight
- **Storage**: PostgreSQL rows for posts (~10KB/post), MinIO for images (~1MB/image avg)
- **Network**: Image uploads go direct to MinIO (no server bandwidth)
- **Third-party**: MinIO on Railway (existing infrastructure)
- **Infrastructure**: No new services required

## 6. Security Considerations

| Risk | Mitigation |
|------|------------|
| Unauthorized access | Role-based middleware checks (editor/admin only) |
| XSS in content | Sanitize HTML output, CSP headers |
| File upload abuse | Validate MIME types, size limits (10MB max) |
| Presigned URL abuse | Short expiry (5 min), unique filenames |
| SQL Injection | Drizzle ORM with parameterized queries |
| CSRF | Better Auth session validation on all mutations |

## 7. Performance Strategy

- **Caching**:
  - Cache post list queries (5 min TTL)
  - Cache presigned URLs in memory (until expiry)
- **Query optimization**:
  - Indexes on slug, status, author_id
  - Paginate post lists (20 per page)
- **Lazy loading**:
  - Load editor component dynamically
  - Lazy load version history
- **Image optimization**:
  - Generate presigned URLs on-demand
  - Consider CDN in front of MinIO (future)

## 8. Testing Strategy

| Type | Coverage | Focus |
|------|----------|-------|
| Unit | 80%+ | API handlers, validation schemas |
| Integration | APIs | Post CRUD, image upload flow |
| E2E | Critical paths | Create post → publish → verify |
| Edge Cases | Specific | Large content, special characters, concurrent edits |

## 9. Rollback Plan

1. **Feature flag** (if needed): Add `ENABLE_CMS=true` env var
2. **Database**: Keep tables, data is preserved
3. **MDX files**: Published content remains as files
4. **Revert code**: Git revert to previous state
5. **Notify**: Alert editors if CMS temporarily unavailable

## 10. Success Metrics

| Metric | Target | Measurement |
|--------|--------|-------------|
| Adoption | 100% of editors using CMS | Track post creation source |
| Time to publish | < 10 min from draft to live | Timestamp diff |
| Image upload success | > 99% | Error rate monitoring |
| Auto-save reliability | 0 data loss incidents | User feedback |
| SEO field usage | > 80% posts have meta desc | DB query |

## 11. Dependencies to Install

```bash
# Toast UI Editor
pnpm add @toast-ui/editor

# Vue 3 wrapper (choose one)
pnpm add tui-editor-vue3
# or
pnpm add @snowdreamtech/vue-tui-editor

# MinIO SDK
pnpm add minio

# UUID generation (for unique filenames)
pnpm add nanoid
```

## 12. Environment Variables Required

```env
# MinIO Configuration
MINIO_ENDPOINT=your-minio-endpoint.railway.app
MINIO_PORT=443
MINIO_USE_SSL=true
MINIO_ACCESS_KEY=your-access-key
MINIO_SECRET_KEY=your-secret-key
MINIO_BUCKET=blog-images
MINIO_PUBLIC_URL=https://your-minio-endpoint.railway.app/blog-images
```

## 13. File Structure

```
src/
├── components/
│   ├── BlogEditor.vue          # Main editor component
│   ├── SeoFields.vue           # SEO input fields
│   ├── HeroImageUpload.vue     # Hero image uploader
│   ├── PostList.vue            # Post list table
│   ├── VersionHistory.vue      # Version list & restore
│   └── PostSettings.vue        # Sidebar settings panel
├── lib/
│   ├── schema.ts               # + posts, post_versions, post_images
│   ├── minio.ts                # MinIO client configuration
│   └── validations.ts          # + post validation schemas
├── pages/
│   ├── api/
│   │   ├── posts/
│   │   │   ├── index.ts        # GET (list), POST (create)
│   │   │   ├── [id].ts         # GET, PUT, DELETE
│   │   │   ├── [id]/
│   │   │   │   ├── publish.ts  # POST publish
│   │   │   │   ├── unpublish.ts
│   │   │   │   └── versions/
│   │   │   │       ├── index.ts
│   │   │   │       └── [versionId]/
│   │   │   │           └── restore.ts
│   │   └── upload/
│   │       ├── presign.ts      # Generate presigned URL
│   │       ├── confirm.ts      # Confirm upload
│   │       └── [id].ts         # DELETE image
│   └── editor/
│       └── posts/
│           ├── index.astro     # Post list
│           ├── new.astro       # New post
│           ├── [id].astro      # Edit post
│           └── [id]/
│               ├── preview.astro
│               └── history.astro
```

## 14. Post-Implementation Review (PIR)

- **Review Date**: Launch + 2 weeks
- **Metrics Check**: Validate all success metrics
- **Lessons Learned**: Document what worked, what didn't
- **Action Items**: Plan follow-up improvements (media library, bulk ops)

---

## 15. Validation & Gap Analysis

### Security Review

| Check | Status | Notes |
|-------|--------|-------|
| Auth on all endpoints | Pass | Middleware checks editor/admin role |
| Input validation | Pass | Zod schemas validate all inputs |
| File upload security | Pass | MIME validation, size limits, presigned URLs |
| XSS prevention | Pass | Sanitize markdown output |
| CSRF protection | Pass | Better Auth session tokens |
| SQL injection | Pass | Drizzle ORM parameterized queries |
| Rate limiting | **Gap** | Consider adding rate limits on upload/publish |

### Architecture Review

| Check | Status | Notes |
|-------|--------|-------|
| Separation of concerns | Pass | API layer separate from UI |
| Data integrity | Pass | Foreign keys, cascade deletes |
| Scalability | Pass | Indexed queries, pagination |
| Backward compatibility | Pass | Additive schema changes only |
| Error handling | Pass | Planned in Phase 7 |
| Conflict handling | **Gap** | Need optimistic locking for concurrent edits |

### SRE/Ops Review (3 AM Test)

| Concern | Mitigation |
|---------|------------|
| MDX file write failure | Wrap in try/catch, keep draft in DB |
| MinIO unavailable | Graceful degradation, retry with backoff |
| DB connection issues | Neon serverless handles reconnection |
| Scheduled post not published | Add health check endpoint, monitor scheduled queue |
| Orphaned images | Periodic cleanup job (future enhancement) |

### Identified Gaps & Resolutions

1. **Rate Limiting**: Add rate limiting middleware for upload endpoints (10 uploads/min)
2. **Concurrent Edits**: Add `updated_at` check before save (optimistic locking)
3. **Orphaned Images**: Track upload session, clean orphans after 24h
4. **Scheduler Reliability**: Use database polling every 60s instead of cron

### Implementation Readiness Score: 8.5/10

**Blocking Issues**: None
**Minor Issues**: Rate limiting and concurrent edit handling should be added during implementation

---

## References

- [Toast UI Editor](https://ui.toast.com/tui-editor/)
- [tui-editor-vue3](https://sirmathays.github.io/tui-editor-vue3/)
- [MinIO JavaScript SDK](https://docs.min.io/community/minio-object-store/developers/javascript/quickstart.html)
- [MinIO Presigned URL Browser Upload](https://min.io/docs/minio/linux/integrations/presigned-put-upload-via-browser.html)
